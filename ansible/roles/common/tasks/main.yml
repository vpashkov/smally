---
# Common server setup tasks

- name: Set hostname
  hostname:
    name: "fastembed-{{ fastembed_environment | default('prod') }}"

- name: Update apt cache
  apt:
    update_cache: yes
    cache_valid_time: 3600

- name: Install essential packages
  apt:
    name:
      - curl
      - wget
      - git
      - vim
      - htop
      - ncdu
      - ufw
      - fail2ban
      - unattended-upgrades
      - apt-transport-https
      - ca-certificates
      - gnupg
      - lsb-release
      - python3-pip
      - python3-setuptools
    state: present
    update_cache: yes

- name: Create fastembed user
  user:
    name: "{{ fastembed_user }}"
    comment: "FastEmbed Application User"
    shell: /bin/bash
    create_home: yes
    groups: sudo
    append: yes
  tags: ['always']

- name: Set up SSH key for fastembed user
  authorized_key:
    user: "{{ fastembed_user }}"
    key: "{{ lookup('file', '~/.ssh/id_ed25519.pub') }}"
    state: present
  tags: ['always']

- name: Create .ansible directory for fastembed user
  file:
    path: "/home/{{ fastembed_user }}/.ansible/tmp"
    state: directory
    owner: "{{ fastembed_user }}"
    group: "{{ fastembed_user }}"
    mode: '0700'
    recurse: yes
  tags: ['always']

- name: Configure sudo for fastembed user
  copy:
    content: "{{ fastembed_user }} ALL=(ALL) NOPASSWD:ALL"
    dest: "/etc/sudoers.d/{{ fastembed_user }}"
    mode: '0440'
    validate: 'visudo -cf %s'
  tags: ['always']

- name: Configure firewall - allow SSH
  ufw:
    rule: allow
    port: '22'
    proto: tcp

- name: Configure firewall - allow HTTP
  ufw:
    rule: allow
    port: '80'
    proto: tcp

- name: Configure firewall - allow HTTPS
  ufw:
    rule: allow
    port: '443'
    proto: tcp

- name: Enable firewall
  ufw:
    state: enabled
    policy: deny

- name: Configure kernel parameters
  sysctl:
    name: "{{ item.name }}"
    value: "{{ item.value }}"
    state: present
    reload: yes
    sysctl_file: /etc/sysctl.d/99-fastembed.conf
  loop:
    - { name: 'net.core.somaxconn', value: '65535' }
    - { name: 'net.ipv4.tcp_max_syn_backlog', value: '8192' }
    - { name: 'net.ipv4.ip_local_port_range', value: '1024 65535' }
    - { name: 'vm.swappiness', value: '10' }
    - { name: 'fs.file-max', value: '2097152' }

- name: Configure file limits
  pam_limits:
    domain: "{{ item.domain }}"
    limit_type: "{{ item.limit_type }}"
    limit_item: nofile
    value: "{{ item.value }}"
  loop:
    - { domain: '*', limit_type: 'soft', value: '65536' }
    - { domain: '*', limit_type: 'hard', value: '65536' }

- name: Set timezone to UTC
  timezone:
    name: UTC

- name: Configure unattended upgrades
  template:
    src: 50unattended-upgrades.j2
    dest: /etc/apt/apt.conf.d/50unattended-upgrades
    mode: '0644'

- name: Enable unattended upgrades
  systemd:
    name: unattended-upgrades
    enabled: yes
    state: started

- name: Configure fail2ban
  template:
    src: jail.local.j2
    dest: /etc/fail2ban/jail.local
    mode: '0644'
  notify: restart fail2ban

- name: Enable fail2ban
  systemd:
    name: fail2ban
    enabled: yes
    state: started
