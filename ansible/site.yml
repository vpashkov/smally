---
# Smally API - Complete Deployment Playbook
# This playbook handles:
# 1. Server setup (packages, user, firewall)
# 2. PostgreSQL and Redis installation
# 3. Application deployment (binaries, configs, systemd)
# 4. Service management
#
# Usage:
#   ansible-playbook -i ansible/inventory/hosts.yml ansible/site.yml --ask-vault-pass
#
# Prerequisites:
#   - Build binaries first: ./scripts/deployment/build-no-buildkit.sh
#   - Vault password for encrypted variables

- name: Deploy Smally API
  hosts: all
  become: yes
  vars:
    smally_user: smally
    smally_app_dir: "/home/{{ smally_user }}/smally-api"
    local_dist_dir: "{{ playbook_dir }}/../dist"

    # PostgreSQL settings
    postgres_version: "15"
    postgres_db: "smally"
    postgres_user: "smally"
    postgres_password: "{{ vault_postgres_password | default('changeme') }}"

    # Redis settings
    redis_bind: "127.0.0.1"
    redis_port: 6379

    # Application settings
    api_port: 8000

  tasks:
    # ========================================
    # 1. SYSTEM SETUP
    # ========================================

    - name: Update apt cache
      apt:
        update_cache: yes
        cache_valid_time: 3600

    - name: Install essential packages
      apt:
        name:
          - curl
          - wget
          - git
          - vim
          - htop
          - ufw
          - ca-certificates
          - gnupg
          - file
        state: present

    - name: Install ONNX Runtime dependencies
      apt:
        name:
          - libgomp1
          - libstdc++6
        state: present

    - name: Check if ONNX Runtime is installed
      stat:
        path: /usr/local/lib/libonnxruntime.so
      register: onnx_installed

    - name: Download ONNX Runtime (ARM64)
      get_url:
        url: https://github.com/microsoft/onnxruntime/releases/download/v1.16.3/onnxruntime-linux-aarch64-1.16.3.tgz
        dest: /tmp/onnxruntime.tgz
        mode: '0644'
      when: not onnx_installed.stat.exists

    - name: Extract ONNX Runtime
      unarchive:
        src: /tmp/onnxruntime.tgz
        dest: /tmp
        remote_src: yes
      when: not onnx_installed.stat.exists

    - name: Install ONNX Runtime libraries
      shell: |
        cp /tmp/onnxruntime-linux-aarch64-1.16.3/lib/* /usr/local/lib/
        ldconfig
      when: not onnx_installed.stat.exists

    - name: Cleanup ONNX Runtime download
      file:
        path: "{{ item }}"
        state: absent
      loop:
        - /tmp/onnxruntime.tgz
        - /tmp/onnxruntime-linux-aarch64-1.16.3
      when: not onnx_installed.stat.exists

    - name: Create smally user
      user:
        name: "{{ smally_user }}"
        comment: "Smally Application User"
        shell: /bin/bash
        create_home: yes
      tags: ['always']

    - name: Create application directory
      file:
        path: "{{ smally_app_dir }}"
        state: directory
        owner: "{{ smally_user }}"
        group: "{{ smally_user }}"
        mode: '0755'

    - name: Configure firewall - SSH
      ufw:
        rule: allow
        port: '22'
        proto: tcp

    - name: Configure firewall - HTTP
      ufw:
        rule: allow
        port: '80'
        proto: tcp

    - name: Configure firewall - HTTPS
      ufw:
        rule: allow
        port: '443'
        proto: tcp

    - name: Enable firewall
      ufw:
        state: enabled
        policy: deny

    # ========================================
    # 2. POSTGRESQL SETUP
    # ========================================

    - name: Install PostgreSQL
      apt:
        name:
          - postgresql
          - postgresql-contrib
          - python3-psycopg2
        state: present

    - name: Ensure PostgreSQL is started
      systemd:
        name: postgresql
        state: started
        enabled: yes

    - name: Create PostgreSQL database
      become_user: postgres
      postgresql_db:
        name: "{{ postgres_db }}"
        state: present

    - name: Create PostgreSQL user
      become_user: postgres
      postgresql_user:
        name: "{{ postgres_user }}"
        password: "{{ postgres_password }}"
        role_attr_flags: CREATEDB
        state: present

    - name: Grant privileges to PostgreSQL user
      become_user: postgres
      postgresql_privs:
        login_db: "{{ postgres_db }}"
        roles: "{{ postgres_user }}"
        type: database
        privs: ALL
        state: present

    # ========================================
    # 3. NGINX SETUP
    # ========================================

    - name: Install Nginx
      apt:
        name: nginx
        state: present

    - name: Remove default Nginx site
      file:
        path: /etc/nginx/sites-enabled/default
        state: absent

    - name: Upload Nginx configuration
      copy:
        src: "{{ playbook_dir }}/../nginx/conf.d/smally-binary.conf"
        dest: /etc/nginx/sites-available/smally
        owner: root
        group: root
        mode: '0644'
      notify: reload nginx

    - name: Enable Nginx site
      file:
        src: /etc/nginx/sites-available/smally
        dest: /etc/nginx/sites-enabled/smally
        state: link
      notify: reload nginx

    - name: Test Nginx configuration
      command: nginx -t
      register: nginx_test
      changed_when: false
      failed_when: nginx_test.rc != 0

    - name: Ensure Nginx is started
      systemd:
        name: nginx
        state: started
        enabled: yes

    # ========================================
    # 4. REDIS SETUP
    # ========================================

    - name: Install Redis
      apt:
        name:
          - redis-server
        state: present

    - name: Configure Redis to bind to localhost
      lineinfile:
        path: /etc/redis/redis.conf
        regexp: '^bind '
        line: "bind {{ redis_bind }}"
      notify: restart redis

    - name: Ensure Redis is started
      systemd:
        name: redis-server
        state: started
        enabled: yes

    # ========================================
    # 4. APPLICATION DEPLOYMENT
    # ========================================

    - name: Check if binaries exist locally
      delegate_to: localhost
      become: no
      stat:
        path: "{{ local_dist_dir }}/{{ item }}"
      register: binary_check
      loop:
        - api
        - create_token
        - generate_keypair

    - name: Verify all binaries exist
      delegate_to: localhost
      become: no
      fail:
        msg: |
          ERROR: Binaries not found in {{ local_dist_dir }}/

          Missing: {{ binary_check.results | rejectattr('stat.exists') | map(attribute='item') | list | join(', ') }}

          Please build binaries first:
            ./scripts/deployment/build-no-buildkit.sh
      when: binary_check.results | rejectattr('stat.exists') | list | length > 0

    - name: Stop smally service if running
      systemd:
        name: smally
        state: stopped
      ignore_errors: yes

    - name: Upload binaries
      copy:
        src: "{{ local_dist_dir }}/{{ item }}"
        dest: "{{ smally_app_dir }}/{{ item }}"
        owner: "{{ smally_user }}"
        group: "{{ smally_user }}"
        mode: '0755'
      loop:
        - api
        - create_token
        - generate_keypair

    - name: Check binary file info
      command: file {{ smally_app_dir }}/api
      register: binary_info
      changed_when: false
      failed_when: false

    - name: Display binary info
      debug:
        var: binary_info.stdout
      when: binary_info.rc == 0

    - name: Check binary dependencies
      command: ldd {{ smally_app_dir }}/api
      register: binary_deps
      changed_when: false
      failed_when: false

    - name: Display binary dependencies
      debug:
        var: binary_deps.stdout_lines
      when: binary_deps.rc == 0

    - name: Test binary execution manually
      command: "{{ smally_app_dir }}/api --version"
      become_user: "{{ smally_user }}"
      register: binary_test
      changed_when: false
      failed_when: false
      timeout: 5
      environment:
        DATABASE_URL: "postgresql://{{ postgres_user }}:{{ postgres_password }}@localhost/{{ postgres_db }}"
        REDIS_URL: "redis://{{ redis_bind }}:{{ redis_port }}"

    - name: Display binary test result
      debug:
        var: binary_test
      when: binary_test.rc is defined

    - name: Upload scripts
      synchronize:
        src: "{{ playbook_dir }}/../scripts/"
        dest: "{{ smally_app_dir }}/scripts/"
        delete: no
        rsync_opts:
          - "--exclude=*.sh~"

    - name: Make all scripts executable
      shell: find {{ smally_app_dir }}/scripts -name "*.sh" -type f -exec chmod +x {} +
      changed_when: false

    - name: Create logs directory
      file:
        path: "{{ smally_app_dir }}/logs"
        state: directory
        owner: "{{ smally_user }}"
        group: "{{ smally_user }}"
        mode: '0755'

    - name: Create .env file
      copy:
        content: |
          # Database
          DATABASE_URL=postgresql://{{ postgres_user }}:{{ postgres_password }}@localhost/{{ postgres_db }}

          # Redis
          REDIS_URL=redis://{{ redis_bind }}:{{ redis_port }}

          # Application
          RUST_LOG=info
          API_PORT={{ api_port }}
        dest: "{{ smally_app_dir }}/.env"
        owner: "{{ smally_user }}"
        group: "{{ smally_user }}"
        mode: '0600'
      register: env_file_updated
      notify: restart smally

    - name: Upload systemd service file
      copy:
        src: "{{ playbook_dir }}/../systemd/smally.service"
        dest: /etc/systemd/system/smally.service
        owner: root
        group: root
        mode: '0644'
      notify: reload systemd

    # ========================================
    # 5. SERVICE MANAGEMENT
    # ========================================

    - name: Reload systemd daemon
      systemd:
        daemon_reload: yes

    - name: Enable and start smally service
      systemd:
        name: smally
        state: started
        enabled: yes

    - name: Check service status
      command: systemctl status smally
      register: service_status
      failed_when: false
      changed_when: false

    - name: Display service status
      debug:
        var: service_status.stdout_lines

    - name: Get service logs
      command: journalctl -u smally -n 50 --no-pager
      register: service_logs
      failed_when: false
      changed_when: false

    - name: Display service logs
      debug:
        var: service_logs.stdout_lines

    - name: Wait for API to be healthy
      uri:
        url: "http://localhost:{{ api_port }}/health"
        status_code: 200
      register: health_check
      until: health_check.status == 200
      retries: 30
      delay: 2

    - name: Display deployment information
      debug:
        msg:
          - "âœ… Smally API deployed successfully!"
          - "API URL: http://{{ ansible_host }}:{{ api_port }}"
          - "Health: http://{{ ansible_host }}:{{ api_port }}/health"
          - "PostgreSQL: {{ postgres_db }} on localhost"
          - "Redis: localhost:{{ redis_port }}"

  handlers:
    - name: reload systemd
      systemd:
        daemon_reload: yes

    - name: restart redis
      systemd:
        name: redis-server
        state: restarted

    - name: reload nginx
      systemd:
        name: nginx
        state: reloaded

    - name: restart smally
      systemd:
        name: smally
        state: restarted
