---
# Binary deployment playbook - deploys pre-built binaries from dist/
# Run build.sh or build-no-buildkit.sh first to create binaries

- name: Deploy Smally API from Pre-built Binaries
  hosts: all
  become: yes
  vars:
    smally_user: smally
    smally_app_dir: "/home/{{ smally_user }}/smally-api"
    local_dist_dir: "{{ playbook_dir }}/../dist"

  tasks:
    - name: Check if binaries exist locally
      delegate_to: localhost
      become: no
      stat:
        path: "{{ local_dist_dir }}/{{ item }}"
      register: binary_check
      loop:
        - api
        - create_api_key

    - name: Verify all binaries exist
      delegate_to: localhost
      become: no
      fail:
        msg: |
          ERROR: Binaries not found in {{ local_dist_dir }}/

          Missing: {{ binary_check.results | rejectattr('stat.exists') | map(attribute='item') | list | join(', ') }}

          Please build binaries first:
            ./scripts/deployment/build.sh              # With BuildKit
            ./scripts/deployment/build-no-buildkit.sh  # Without BuildKit
            ./scripts/deployment/build-native.sh       # Native (macOS only)
      when: binary_check.results | rejectattr('stat.exists') | list | length > 0

    - name: Stop smally service
      systemd:
        name: smally
        state: stopped
      ignore_errors: yes

    - name: Upload binaries to server
      copy:
        src: "{{ local_dist_dir }}/{{ item }}"
        dest: "{{ smally_app_dir }}/{{ item }}"
        owner: "{{ smally_user }}"
        group: "{{ smally_user }}"
        mode: '0755'
      loop:
        - api
        - create_api_key

    - name: Upload scripts
      synchronize:
        src: "{{ playbook_dir }}/../scripts/"
        dest: "{{ smally_app_dir }}/scripts/"
        delete: no
        rsync_opts:
          - "--exclude=*.sh~"

    - name: Find all shell scripts
      find:
        paths: "{{ smally_app_dir }}/scripts"
        patterns: "*.sh"
        recurse: yes
      register: shell_scripts

    - name: Make scripts executable
      file:
        path: "{{ item.path }}"
        mode: '0755'
      loop: "{{ shell_scripts.files }}"
      when: shell_scripts.files | length > 0

    - name: Start smally service
      systemd:
        name: smally
        state: started
        daemon_reload: yes

    - name: Wait for API to be healthy
      uri:
        url: "http://localhost:8000/health"
        status_code: 200
      register: health_check
      until: health_check.status == 200
      retries: 30
      delay: 2

    - name: Display deployment information
      debug:
        msg:
          - "Smally API deployed successfully!"
          - "API URL: https://{{ ansible_host }}/v1"
          - "Check health: curl http://localhost:8000/health"
