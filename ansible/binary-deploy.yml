---
# Binary deployment playbook - builds locally, deploys pre-built binaries
# Much faster than building on remote server

- name: Build and Deploy Smally API (Binary Mode)
  hosts: all
  become: yes
  vars:
    smally_user: smally
    smally_app_dir: "/home/{{ smally_user }}/smally-api"
    local_dist_dir: "{{ playbook_dir }}/../dist"

  tasks:
    - name: Build binaries locally
      delegate_to: localhost
      become: no
      block:
        - name: Get git hash
          command: git rev-parse --short HEAD
          args:
            chdir: "{{ playbook_dir }}/.."
          register: git_hash
          changed_when: false

        - name: Get git branch
          command: git rev-parse --abbrev-ref HEAD
          args:
            chdir: "{{ playbook_dir }}/.."
          register: git_branch
          changed_when: false

        - name: Get git date
          command: git log -1 --format=%ci
          args:
            chdir: "{{ playbook_dir }}/.."
          register: git_date
          changed_when: false

        - name: Check git dirty status
          shell: git status --porcelain | wc -l | awk '{if ($1 > 0) print "true"; else print "false"}'
          args:
            chdir: "{{ playbook_dir }}/.."
          register: git_dirty
          changed_when: false

        - name: Get build timestamp
          command: date -u +"%Y-%m-%dT%H:%M:%S%z"
          register: build_timestamp
          changed_when: false

        - name: Set git facts
          set_fact:
            git_hash: "{{ git_hash.stdout | trim }}"
            git_branch: "{{ git_branch.stdout | trim }}"
            git_date: "{{ git_date.stdout | trim }}"
            git_dirty: "{{ git_dirty.stdout | trim }}"
            build_timestamp: "{{ build_timestamp.stdout | trim }}"

        - name: Build Docker image with binaries (using BuildKit for cache)
          command: >
            docker build
            --target builder
            --build-arg GIT_HASH="{{ git_hash }}"
            --build-arg GIT_BRANCH="{{ git_branch }}"
            --build-arg GIT_DATE="{{ git_date }}"
            --build-arg GIT_DIRTY="{{ git_dirty }}"
            --build-arg BUILD_TIMESTAMP="{{ build_timestamp }}"
            --build-arg RUST_VERSION="1.91.0"
            -t smally-builder:latest
            -f Dockerfile
            .
          args:
            chdir: "{{ playbook_dir }}/.."
          environment:
            DOCKER_BUILDKIT: "1"

        - name: Create dist directory
          file:
            path: "{{ local_dist_dir }}"
            state: directory

        - name: Extract binaries from Docker image
          shell: |
            docker create --name smally-builder-temp smally-builder:latest
            docker cp smally-builder-temp:/build/target/release/api {{ local_dist_dir }}/api
            docker cp smally-builder-temp:/build/target/release/create_api_key {{ local_dist_dir }}/create_api_key
            docker rm smally-builder-temp
          args:
            chdir: "{{ playbook_dir }}/.."

        - name: Make binaries executable
          file:
            path: "{{ local_dist_dir }}/{{ item }}"
            mode: '0755'
          loop:
            - api
            - create_api_key

    - name: Stop smally service
      systemd:
        name: smally
        state: stopped
      ignore_errors: yes

    - name: Upload binaries to server
      copy:
        src: "{{ local_dist_dir }}/{{ item }}"
        dest: "{{ smally_app_dir }}/{{ item }}"
        owner: "{{ smally_user }}"
        group: "{{ smally_user }}"
        mode: '0755'
      loop:
        - api
        - create_api_key

    - name: Upload scripts
      synchronize:
        src: "{{ playbook_dir }}/../scripts/"
        dest: "{{ smally_app_dir }}/scripts/"
        delete: no
        rsync_opts:
          - "--chmod=D755,F755"
          - "--exclude=*.sh~"

    - name: Ensure scripts are executable
      file:
        path: "{{ smally_app_dir }}/scripts"
        state: directory
        recurse: yes
        mode: 'u+x,g+x,o+x'
      when: item is match(".*\.sh$")
      with_fileglob:
        - "{{ smally_app_dir }}/scripts/**/*.sh"

    - name: Start smally service
      systemd:
        name: smally
        state: started
        daemon_reload: yes

    - name: Wait for API to be healthy
      uri:
        url: "http://localhost:8000/health"
        status_code: 200
      register: health_check
      until: health_check.status == 200
      retries: 30
      delay: 2

    - name: Display deployment information
      debug:
        msg:
          - "Smally API deployed successfully!"
          - "API URL: https://{{ ansible_host }}/v1"
          - "Check health: curl http://localhost:8000/health"
