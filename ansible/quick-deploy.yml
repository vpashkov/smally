---
# Smally API - Quick Deploy Playbook
# For code-only changes - skips infrastructure setup

- name: Quick Deploy Smally API
  hosts: smally
  become: yes
  gather_facts: no

  vars:
    smally_user: smally
    smally_home: /home/smally
    smally_app_dir: "{{ smally_home }}/smally-api"

  tasks:
    - name: Pull latest code
      git:
        repo: "{{ smally_git_repo }}"
        dest: "{{ smally_app_dir }}"
        version: "{{ smally_git_branch }}"
        force: yes
        accept_hostkey: yes
      become_user: "{{ smally_user }}"

    - name: Run quick deployment script
      command: "{{ smally_app_dir }}/scripts/deployment/quick-deploy.sh"
      args:
        chdir: "{{ smally_app_dir }}"
      become_user: "{{ smally_user }}"
      register: deploy_result

    - name: Display deployment output
      debug:
        var: deploy_result.stdout_lines

    - name: Wait for API to be healthy
      uri:
        url: "http://localhost:8000/health"
        status_code: 200
      register: health_check
      until: health_check.status == 200
      retries: 10
      delay: 3

    - name: Display success message
      debug:
        msg:
          - "Quick deploy complete!"
          - "API URL: https://{{ smally_domain }}/v1"
          - "Time saved: ~3-5 minutes vs full deploy"
